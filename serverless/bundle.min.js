var e=require("leanengine"),a=require("request");async function t(t){var n=t.params.fileNameArr,i=await e.Cloud.run("getShimoTokenRaw");return new Promise((e,t)=>{a.post(`https://uploader.shimo.im/token?server=qiniu&type=attachments&accessToken=${i}`,{json:!0,body:n},(a,n,i)=>{a?t(!1):e(i)})})}require("../tools/identifier.js").run({rules:"!vscode||local",func:async()=>{await t({params:{fileNameArr:["test.mp4"]}})}}),e.Cloud.define("getQiniuJSON",async function(e){return await t(e)}),e.Cloud.define("getShimoTokenRaw",async function(e){return await new Promise((e,t)=>{a.post("https://shimo.im/api/upload/token",{json:!0,headers:{Cookie:process.env.shimoCookie}},(a,n,i)=>{if(a)t(!1);else{var r=i.data.accessToken.toString();e(r)}})})}),e.Cloud.define("postFormShimo",async function(t){return await async function(t){var n=await e.Cloud.run("getShimoTokenRaw"),i=t.params.data,r=t.params.filename;return new Promise((o,s)=>{const c=a.post({url:"https://uploader.shimo.im/upload2"},function(a,n,i){var s=JSON.parse(i),c=r.split("."),u=c.pop(),l=c.join(".");s.data.type=u,s.data.name=l,s.class=t.params.class,s.lottieURL=t.params.lottieURL;var p=e.Cloud.run("updateShimo",s);o(p)}).form();c.append("server","qiniu"),c.append("type","attachments"),c.append("accessToken",n),c.append("file",i,{filename:r})})}(t)}),e.Cloud.define("save2LeanCloud",async function(a){return await function(a){var t=a.params,n=new(e.Object.extend(t.chosenClass));for(var i in t)n.set(i,t[i]);n.save().then(function(){},function(e){})}(a)});var n=require("axios");const r=require("qs");require("fs");var o="K8CWmBMqMtYYpU1f",s="K8CWmBMqMtYYpU1f",c=process.env.shimoCookie,u={Accept:"application/vnd.shimo.v2+json","Accept-Encoding":"br, gzip, deflate","Accept-Language":"zh-cn",Authorization:"Bearer 62cbbe058449d3db514c7aece09afe0c13d0e501ed07624478704405d6cef617200823a164c086b87153edbba7acabcbc78c475c53a19a89df10cc2f872855a8","Cache-Control":"no-cache",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 12_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/16B92",Cookie:c};function l(e){return async function(e){try{return[await e,null]}catch(e){return[null,e]}}(n.create({transformRequest:[e=>r.stringify(e)]})(e))}async function p(e,a){var t,n,i=[],r=await async function(e){var a,t=[],n={Accept:"*/*","Accept-Encoding":"br, gzip, deflate","Accept-Language":"zh-cn",Connection:"keep-alive",Referer:"https://shimo.im/docs/K8CWmBMqMtYYpU1f","User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_5) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/11.1.1 Safari/605.1.15","X-CSRF-Token":"JDvV3azC-fmyRaI4kR98csJiXEhmprm78WMw",Cookie:c+"_csrf=q4MNRquXrxATGBLCwExHVcIs;"};const[i,r]=await l({method:"get",url:`https://shimo.im/smapi/files/${e}/discussions?limit=99999999`,headers:n});if(!r){for(var o in a=i.data.data.list){var s=a[o];t.push(s.data.content)}return t}}(e);r.length;for(var o in n=await async function(e){var a="https://api.shimo.im/files/"+e+"?content=true";const[t,n]=await l({method:"get",url:a,headers:u});if(!n){var i=[],r=t.data.content;r=JSON.parse(r);for(var o=0;o<r.length;o++){var s=r[o][1].attachment;s&&i.push(s)}return i}}(a),t=0!=r.length?r.join("\n"):"",r)r[o].match("size")&&Number(JSON.parse(r[o]).size);n.forEach(async e=>{var a=e,n=a.name.split("."),r=n.pop(),o=n.join(".");if(!t.match(a.url)){var s={type:r,name:o,size:a.size,uploaderURL:a.url},c=await m(s);i.push(c)}});i.length;return i}async function m(a){a.shortURL=await async function(e){var a=e.match(/[a-zA-z]+:\/\/[^\s]*/g);for(i=0;i<a.length;i++){var t="http://api.weibo.com/2/short_url/shorten.json?source=2849184197&url_long="+encodeURIComponent(a[i]),r=(await n.get(t)).data.urls[0].url_short;e=e.replace(a[i],r)}return e}(a.uploaderURL),a.name_trans=await async function(e){try{var a,t=await n({method:"POST",url:"http://translate.google.cn/translate_a/single",params:{dt:"t",q:e,tl:"zh-CN",ie:"UTF-8",sl:"auto",client:"ia",dj:"1"},headers:{Accept:"*/*","Accept-Encoding":"br, gzip, deflate","Accept-Language":"zh-cn",Connection:"keep-alive",Cookie:"NID=154=Vf6msfWVov9Icm1WMYfq3dQ3BGHUlq6Txh5RHjnBtN48ZIZAdE_iQjxrrOMsOhbRlXXHtReYEm1rRKGUD3WsP1DhA0sO0nDf5S-J69qEBYRzIAY8nd1cE20wAKOr3cXxxPgwN12Dc5ly07v-F7RY-6Uv3ldkWGYeXWTgwkPR6Cs",Host:"translate.google.cn","User-Agent":"GoogleTranslate/5.26.59113 (iPhone; iOS 12.1; zh_CN; iPhone10,3)"}}),i="",r=t.data.sentences;if(r.length>1)for(a=0;a<r.length;++a)i+=r[a].trans+"\n";else i=r[0].trans;return i}catch(a){return e}}(a.name.toLowerCase()),content=JSON.stringify(a);var t,r,s=await async function(e,a){const[t,n]=await l({method:"post",url:"https://shimo.im/smapi/files/"+e+"/discussions",headers:{Cookie:c},data:{content:a}});if(!n)return 0!==t.data.code?"error":t.data}(o,content);return a.id=s.data.id,a.unixus=s.data.unixus,e.Cloud.run("save2LeanCloud",a),`${r=a.type,r.match(/[a-zA-Z]/g)?r.match(/mp4|mov|avi/gi)?"🎬":r.match(/webm|mkv|avi/gi)?"▶️":r.match(/mp3|ogg|wav|flac|ape|alca|aac/gi)?"🎵":r.match(/zip|7z|rar/gi)?"📦":r.match(/dmg|iso/gi)?"💽":r.match(/ai|psd|aep/gi)?"📐":r.match(/ppt|pptx|key/gi)?"📽️":r.match(/ttf|otf/gi)?"🔤️":r.match(/doc|pdf/gi)?"️📄":"❓":r} ${a.name} | ${t=a.shortURL,t.replace(/[a-zA-z]+:\/\//g,"")}`}async function d(e){var a;if(e&&0==e.params.code){var t=e.params.data,n=e.params.class||"ShimoBed",i={type:t.type,name:t.name,size:t.size,uploaderURL:t.url,lottieURL:e.params.lottieURL,chosenClass:n};m(i),a=[i]}else a=await p(o,s);return a}require("../tools/identifier.js").run({rules:"!vscode||local",func:()=>{d()}}),e.Cloud.define("updateShimo",async function(e){return await d(e)});