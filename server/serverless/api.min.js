const e=require("leanengine"),a=require("request");var t=e.Cloud.define;t("getQiniuJSON",t=>(async function(t){var n=t.params.fileNameArr,o=await e.Cloud.run("getShimoTokenRaw");return console.log(o),new Promise((e,t)=>{a.post(`https://uploader.shimo.im/token?server=qiniu&type=attachments&accessToken=${o}`,{json:!0,body:n},(a,n,o)=>{a?t(!1):(console.log(o),e(o))})})})(t)),t("getShimoTokenRaw",e=>(function(e){return new Promise((e,t)=>{a.post("https://shimo.im/api/upload/token",{json:!0,headers:{Cookie:process.env.shimoCookie}},(a,n,o)=>{if(a)t(!1);else{var i=o.data.accessToken.toString();e(i)}})})})()),t("postFormShimo",t=>(async function(t){var n=await e.Cloud.run("getShimoTokenRaw"),o=t.params.data,i=t.params.filename;return new Promise((s,r)=>{const c=a.post({url:"https://uploader.shimo.im/upload2"},function(a,n,o){var r=JSON.parse(o),c=i.split("."),l=c.pop(),p=c.join(".");r.data.type=l,r.data.name=p,r.class=t.params.class,r.lottieURL=t.params.lottieURL;var u=e.Cloud.run("updateShimo",r);s(u)}).form();c.append("server","qiniu"),c.append("type","attachments"),c.append("accessToken",n),c.append("file",o,{filename:i})})})(t)),t("save2LeanCloud",a=>(function(a){var t=a.params,n=new(e.Object.extend(t.chosenClass));for(var o in t)n.set(o,t[o]);n.save().then(function(){console.log("已上传到LeanCloud")},function(e){console.log(JSON.stringify(e))})})(a)),t("test",e=>(function(e){return console.log("你好厉害哦!!!"),"success!!!"})());var n=require("axios");const o=require("qs");require("fs");var s="K8CWmBMqMtYYpU1f",r="K8CWmBMqMtYYpU1f",c=process.env.shimoCookie,l={Accept:"application/vnd.shimo.v2+json","Accept-Encoding":"br, gzip, deflate","Accept-Language":"zh-cn",Authorization:"Bearer 62cbbe058449d3db514c7aece09afe0c13d0e501ed07624478704405d6cef617200823a164c086b87153edbba7acabcbc78c475c53a19a89df10cc2f872855a8","Cache-Control":"no-cache",Connection:"keep-alive","User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 12_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/16B92",Cookie:c};function p(e){return async function(e){try{return[await e,null]}catch(e){return[null,e]}}(n.create({transformRequest:[e=>o.stringify(e)]})(e))}function u(e){return(e/1073741824).toFixed(2)}async function m(e,a){var t,n,o=[],i=0,s=0,r=await async function(e){var a,t=[],n={Accept:"*/*","Accept-Encoding":"br, gzip, deflate","Accept-Language":"zh-cn",Connection:"keep-alive",Referer:"https://shimo.im/docs/K8CWmBMqMtYYpU1f","User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_5) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/11.1.1 Safari/605.1.15","X-CSRF-Token":"JDvV3azC-fmyRaI4kR98csJiXEhmprm78WMw",Cookie:c+"_csrf=q4MNRquXrxATGBLCwExHVcIs;"};const[o,i]=await p({method:"get",url:`https://shimo.im/smapi/files/${e}/discussions?limit=99999999`,headers:n});if(i)return console.log("getDiscussion请求出错: "+i);for(var s in a=o.data.data.list){var r=a[s];t.push(r.data.content)}return t}(e),m=r.length;for(var d in n=await async function(e){var a="https://api.shimo.im/files/"+e+"?content=true";const[t,n]=await p({method:"get",url:a,headers:l});if(n)return console.log("getAttachment请求出错: "+n);var o=[],i=t.data.content;i=JSON.parse(i);for(var s=0;s<i.length;s++){var r=i[s][1].attachment;r&&o.push(r)}return o}(a),t=0!=r.length?r.join("\n"):"",r)r[d].match("size")&&(i+=Number(JSON.parse(r[d]).size));return n.forEach(async e=>{var a=e,n=a.name.split("."),i=n.pop(),s=n.join(".");if(!t.match(a.url)){var r={type:i,name:s,size:a.size,uploaderURL:a.url},c=await h(r);o.push(c)}}),0!=(s=o.length)?(console.log("共增加"+s+"个新项目，已上传 "+(m+s)+" 个文件，累计 "+u(i)+" GB"),console.log("\n"+o.join("\n")+"\n")):console.log("已上传 "+m+" 个文件，累计 "+u(i)+" GB"),o}async function h(a){a.shortURL=await async function(e){var a=e.match(/[a-zA-z]+:\/\/[^\s]*/g);for(i=0;i<a.length;i++){var t="http://api.weibo.com/2/short_url/shorten.json?source=2849184197&url_long="+encodeURIComponent(a[i]),o=(await n.get(t)).data.urls[0].url_short;e=e.replace(a[i],o)}return e}(a.uploaderURL),a.name_trans=await async function(e){try{var a,t=await n({method:"POST",url:"http://translate.google.cn/translate_a/single",params:{dt:"t",q:e,tl:"zh-CN",ie:"UTF-8",sl:"auto",client:"ia",dj:"1"},headers:{Accept:"*/*","Accept-Encoding":"br, gzip, deflate","Accept-Language":"zh-cn",Connection:"keep-alive",Cookie:"NID=154=Vf6msfWVov9Icm1WMYfq3dQ3BGHUlq6Txh5RHjnBtN48ZIZAdE_iQjxrrOMsOhbRlXXHtReYEm1rRKGUD3WsP1DhA0sO0nDf5S-J69qEBYRzIAY8nd1cE20wAKOr3cXxxPgwN12Dc5ly07v-F7RY-6Uv3ldkWGYeXWTgwkPR6Cs",Host:"translate.google.cn","User-Agent":"GoogleTranslate/5.26.59113 (iPhone; iOS 12.1; zh_CN; iPhone10,3)"}}),o="",i=t.data.sentences;if(i.length>1)for(a=0;a<i.length;++a)o+=i[a].trans+"\n";else o=i[0].trans;return console.log("谷歌翻译成功结果："+o),o}catch(a){return console.log("谷歌翻译失败"),e}}(a.name.toLowerCase()),content=JSON.stringify(a);var t,o,r=await async function(e,a){const[t,n]=await p({method:"post",url:"https://shimo.im/smapi/files/"+e+"/discussions",headers:{Cookie:c},data:{content:a}});return n?console.log("Discussion请求出错: "+n):0!==t.data.code?(console.log("讨论上传失败，错误信息：『"+t.message+"』\n详情请查看：https://shimo.im/docs/"+e),"error"):t.data}(s,content);return a.id=r.data.id,a.unixus=r.data.unixus,e.Cloud.run("save2LeanCloud",a),`${o=a.type,o.match(/[a-zA-Z]/g)?o.match(/mp4|mov|avi/gi)?"🎬":o.match(/webm|mkv|avi/gi)?"▶️":o.match(/mp3|ogg|wav|flac|ape|alca|aac/gi)?"🎵":o.match(/zip|7z|rar/gi)?"📦":o.match(/dmg|iso/gi)?"💽":o.match(/ai|psd|aep/gi)?"📐":o.match(/ppt|pptx|key/gi)?"📽️":o.match(/ttf|otf/gi)?"🔤️":o.match(/doc|pdf/gi)?"️📄":"❓":o} ${a.name} | ${t=a.shortURL,t.replace(/[a-zA-z]+:\/\//g,"")}`}t("updateShimo",e=>(async function(e){var a;if(e&&0==e.params.code){var t=e.params.data;console.log("[1;31;47m已经成功传入updateShimo这里了[0m");var n=e.params.class||"ShimoBed",o={type:t.type,name:t.name,size:t.size,uploaderURL:t.url,lottieURL:e.params.lottieURL,chosenClass:n};h(o),a=[o]}else a=await m(s,r);return a})(e));